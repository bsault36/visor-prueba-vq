<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Visor 3D - Ensamblaje</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    html,body { height:100%; margin:0; font-family: Arial, sans-serif; }
    #container { display: grid; grid-template-columns: 1fr 320px; height:100vh; }
    #viewer { background:#e9e9e9; }
    #sidebar { background:#fff; border-left:1px solid #ddd; padding:12px; overflow:auto; }
    header { font-weight:700; margin-bottom:8px; }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th,td { padding:6px 8px; border-bottom:1px solid #eee; text-align:left; }
    tr:hover { background:#f5f5f5; cursor:pointer; }
    #instructions { font-size:13px; color:#555; margin-top:8px; }
  </style>
</head>
<body>
  <div id="container">
    <div id="viewer"></div>
    <div id="sidebar">
      <header>Lista de Partes (BOM)</header>
      <div id="bom-area">Cargando BOM...</div>
      <div id="instructions">
        <p><strong>Instrucciones rápidas:</strong></p>
        <ol>
          <li>Convierta su ensamblaje a <code>model.gltf</code> (ver README).</li>
          <li>Coloque <code>model.gltf</code> en la misma carpeta que este <code>index.html</code>.</li>
          <li>Abra <code>index.html</code> en un servidor web (GitHub Pages, Netlify o local).</li>
          <li>Escanee el QR que apunte al URL donde hospede estos archivos.</li>
        </ol>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.161.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.161.0/examples/js/loaders/GLTFLoader.js"></script>

  <script>
    // Basic three.js scene
    const container = document.getElementById('viewer');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    container.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    camera.position.set(2,2,2);
    controls.update();

    const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
    scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 0.8);
    dir.position.set(5,10,7);
    scene.add(dir);

    const grid = new THREE.GridHelper(10, 20);
    scene.add(grid);

    // Load glTF model (expects model.gltf in same folder)
    const loader = new THREE.GLTFLoader();
    loader.load('model.gltf', function(gltf) {
      const model = gltf.scene;
      scene.add(model);
      // compute bbox and frame camera
      const box = new THREE.Box3().setFromObject(model);
      const size = box.getSize(new THREE.Vector3()).length();
      const center = box.getCenter(new THREE.Vector3());
      controls.target.copy(center);
      camera.position.copy(center.clone().add(new THREE.Vector3(size, size, size)));
      camera.lookAt(center);
      controls.update();
    }, undefined, function(err){
      console.error(err);
      const msg = document.createElement('div');
      msg.style.position='absolute';
      msg.style.left='10px'; msg.style.top='10px';
      msg.style.background='rgba(255,255,255,0.9)';
      msg.style.padding='8px'; msg.style.border='1px solid #ccc';
      msg.innerText = 'No se encontró model.gltf. Coloque el glTF en la misma carpeta.';
      container.appendChild(msg);
    });

    // Handle resize
    window.addEventListener('resize', function(){
      camera.aspect = container.clientWidth / container.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(container.clientWidth, container.clientHeight);
    });

    // Render loop
    function animate(){ requestAnimationFrame(animate); renderer.render(scene, camera); }
    animate();

    // Load BOM CSV and render table
    fetch('bom.csv').then(r => r.text()).then(text => {
      const lines = text.trim().split('\\n');
      const headers = lines[0].split(',');
      const rows = lines.slice(1).map(l => l.split(','));
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      headers.forEach(h => { const th = document.createElement('th'); th.innerText = h; trh.appendChild(th); });
      thead.appendChild(trh);
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      rows.forEach(r => {
        const tr = document.createElement('tr');
        r.forEach(c => { const td = document.createElement('td'); td.innerText = c; tr.appendChild(td); });
        // on row click, try to find a mesh with same name and highlight it
        tr.addEventListener('click', () => {
          const partName = r[0];
          highlightPart(partName);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      const area = document.getElementById('bom-area');
      area.innerHTML = '';
      area.appendChild(table);
    }).catch(e => {
      document.getElementById('bom-area').innerText = 'No se pudo cargar bom.csv';
    });

    // Simple highlight function: searches by object name and toggles emissive
    function highlightPart(name) {
      scene.traverse(obj => {
        if (obj.isMesh) {
          if (obj.name && obj.name.includes(name.split('.')[0])) {
            obj.material && (obj.material.emissive = new THREE.Color(0x333300));
            // focus camera
            const box = new THREE.Box3().setFromObject(obj);
            const center = box.getCenter(new THREE.Vector3());
            controls.target.copy(center);
            camera.position.copy(center.clone().add(new THREE.Vector3(1,1,1)));
            controls.update();
          } else {
            // reset (best effort)
            if (obj.material && obj.material.emissive) obj.material.emissive.setHex(0x000000);
          }
        }
      });
    }

  </script>
</body>
</html>
